---
import BaseLayout from "../layouts/BaseLayout.astro";
import SnippetCard from "../components/SnippetCard.astro";
import { groupByCategory, loadSnippets } from "../lib/csv";

const snippets = loadSnippets();
const categories = Array.from(new Set(snippets.map((snippet) => snippet.category)));
const types = Array.from(new Set(snippets.map((snippet) => snippet.type)));
const groupedByCategory = groupByCategory(snippets);
const latest = [...snippets].sort(
  (a, b) => new Date(b.updated_at).getTime() - new Date(a.updated_at).getTime(),
);

const withBase = (path: string) => `${import.meta.env.BASE_URL}${path.replace(/^\//, "")}`;
---
<BaseLayout title="Astro Snippet Library" description="CSV ã‹ã‚‰èª­ã¿è¾¼ã‚€ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¹ãƒ‹ãƒšãƒƒãƒˆé›†">
  <section class="grid gap-6 rounded-3xl border border-white/10 bg-white/5 p-6 shadow-xl shadow-indigo-500/10">
    <div class="flex flex-wrap items-center gap-4">
      <div>
        <p class="text-xs font-semibold uppercase tracking-[0.2em] text-indigo-200">Search</p>
        <h2 class="text-2xl font-bold">ã‚¹ãƒ‹ãƒšãƒƒãƒˆæ¤œç´¢</h2>
      </div>
      <div class="ml-auto flex flex-wrap gap-3 text-sm text-slate-200/80">
        <span class="rounded-full bg-white/10 px-3 py-1 ring-1 ring-white/10">{snippets.length} ä»¶</span>
        <span id="result-count" class="rounded-full bg-indigo-500/20 px-3 py-1 ring-1 ring-indigo-400/40">{snippets.length} ä»¶ãƒ’ãƒƒãƒˆ</span>
      </div>
    </div>
    <div class="grid gap-3 sm:grid-cols-[2fr_1fr_1fr]">
      <label class="flex items-center gap-2 rounded-xl border border-white/10 bg-slate-950/60 px-3 py-2 text-sm text-slate-100 shadow-inner">
        <span class="text-indigo-200">ğŸ”</span>
        <input
          id="search"
          type="search"
          placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ (ã‚¿ã‚¤ãƒˆãƒ«ãƒ»èª¬æ˜ãƒ»ã‚¿ã‚°ãƒ»ã‚³ãƒ¼ãƒ‰)"
          class="w-full bg-transparent text-sm outline-none placeholder:text-slate-400"
        />
      </label>
      <label class="flex items-center gap-2 rounded-xl border border-white/10 bg-slate-950/60 px-3 py-2 text-sm text-slate-100 shadow-inner">
        <span class="text-indigo-200">ğŸ“</span>
        <select id="category" class="w-full bg-transparent text-sm outline-none">
          <option value="">ã™ã¹ã¦ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼</option>
          {categories.map((category) => (
            <option value={category}>{category}</option>
          ))}
        </select>
      </label>
      <label class="flex items-center gap-2 rounded-xl border border-white/10 bg-slate-950/60 px-3 py-2 text-sm text-slate-100 shadow-inner">
        <span class="text-indigo-200">ğŸ·ï¸</span>
        <select id="type" class="w-full bg-transparent text-sm outline-none">
          <option value="">ã™ã¹ã¦ã®ã‚¿ã‚¤ãƒ—</option>
          {types.map((type) => (
            <option value={type}>{type}</option>
          ))}
        </select>
      </label>
    </div>

    <div id="snippet-list" class="grid gap-4 sm:grid-cols-2">
      {snippets.map((snippet) => (
        <SnippetCard snippet={snippet} />
      ))}
    </div>
  </section>

  <section class="grid gap-4 rounded-3xl border border-white/10 bg-white/5 p-6 shadow-xl shadow-indigo-500/10">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-xs font-semibold uppercase tracking-[0.2em] text-indigo-200">Latest</p>
        <h2 class="text-2xl font-bold">æœ€è¿‘æ›´æ–°ã•ã‚ŒãŸã‚¹ãƒ‹ãƒšãƒƒãƒˆ</h2>
      </div>
      <a
        href="#search"
        class="rounded-full border border-white/15 bg-white/10 px-4 py-2 text-sm font-semibold text-white transition hover:border-indigo-200/50 hover:bg-white/20"
      >
        ã™ã¹ã¦ã‚’è¦‹ã‚‹
      </a>
    </div>
    <div class="grid gap-4 md:grid-cols-3">
      {latest.slice(0, 3).map((snippet) => (
        <article class="rounded-2xl border border-white/10 bg-slate-950/60 p-4">
          <p class="text-xs uppercase tracking-[0.2em] text-indigo-200">{snippet.category}</p>
          <h3 class="mt-2 text-lg font-semibold text-white">{snippet.title}</h3>
          <p class="text-sm text-slate-200/80">{snippet.description}</p>
          <div class="mt-3 flex flex-wrap gap-2 text-xs text-slate-200/80">
            <span class="rounded-full bg-white/10 px-2 py-0.5 ring-1 ring-white/10">æ›´æ–°æ—¥ {snippet.updated_at}</span>
            <span class="rounded-full bg-white/10 px-2 py-0.5 ring-1 ring-white/10">{snippet.type}</span>
          </div>
          <a
            href={withBase(`/snippets/${snippet.slug}/`)}
            class="mt-3 inline-flex items-center gap-2 text-sm font-semibold text-indigo-100 hover:text-white"
          >
            è©³ç´°ã‚’é–‹ã â†’
          </a>
        </article>
      ))}
    </div>
  </section>

  <section class="grid gap-4 rounded-3xl border border-white/10 bg-white/5 p-6 shadow-xl shadow-indigo-500/10">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-xs font-semibold uppercase tracking-[0.2em] text-indigo-200">Category</p>
        <h2 class="text-2xl font-bold">ã‚«ãƒ†ã‚´ãƒªãƒ¼åˆ¥ã®ã‚¹ãƒ‹ãƒšãƒƒãƒˆ</h2>
      </div>
      <span class="rounded-full bg-white/10 px-3 py-1 text-xs font-semibold ring-1 ring-white/10">{categories.length} ã‚«ãƒ†ã‚´ãƒªãƒ¼</span>
    </div>
    <div class="grid gap-3 md:grid-cols-2">
      {Object.entries(groupedByCategory).map(([category, items]) => (
        <article class="rounded-2xl border border-white/10 bg-slate-950/60 p-4">
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold">{category}</h3>
            <span class="rounded-full bg-indigo-500/20 px-3 py-1 text-xs font-semibold text-indigo-50 ring-1 ring-indigo-300/40">{items.length} ä»¶</span>
          </div>
          <ul class="mt-3 space-y-2 text-sm text-slate-200/85">
            {items.map((item) => (
              <li class="flex items-center justify-between gap-3 rounded-xl border border-white/10 bg-white/5 px-3 py-2">
                <div>
                  <p class="font-semibold text-white">{item.title}</p>
                  <p class="text-xs text-slate-300/80">{item.description}</p>
                </div>
                <a
                  href={withBase(`/snippets/${item.slug}/`)}
                  class="rounded-full border border-white/15 bg-white/10 px-3 py-1 text-[11px] font-semibold text-white transition hover:border-indigo-200/50 hover:bg-white/20"
                >
                  è©³ç´°
                </a>
              </li>
            ))}
          </ul>
        </article>
      ))}
    </div>
  </section>

  <script type="module">
    document.addEventListener("DOMContentLoaded", () => {
      const searchInput = document.querySelector<HTMLInputElement>("#search");
      const categorySelect = document.querySelector<HTMLSelectElement>("#category");
      const typeSelect = document.querySelector<HTMLSelectElement>("#type");
      const cards = Array.from(document.querySelectorAll<HTMLElement>("[data-snippet]"));
      const resultCount = document.querySelector<HTMLElement>("#result-count");

      const applyFilters = () => {
        const keyword = searchInput?.value.trim().toLowerCase() ?? "";
        const category = categorySelect?.value ?? "";
        const type = typeSelect?.value ?? "";

        let visible = 0;
        cards.forEach((card) => {
          const matchesKeyword = keyword
            ? ["title", "description", "tags", "code"].some((field) =>
                card.dataset[field]?.includes(keyword),
              )
            : true;
          const matchesCategory = category ? card.dataset.category === category : true;
          const matchesType = type ? card.dataset.type === type : true;
          const show = matchesKeyword && matchesCategory && matchesType;
          card.style.display = show ? "flex" : "none";
          if (show) visible += 1;
        });

        if (resultCount) {
          resultCount.textContent = `${visible} ä»¶ãƒ’ãƒƒãƒˆ`;
        }
      };

      [searchInput, categorySelect, typeSelect].forEach((el) => el?.addEventListener("input", applyFilters));
      applyFilters();

    });
  </script>
</BaseLayout>
