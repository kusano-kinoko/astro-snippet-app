---
import BaseLayout from "../layouts/BaseLayout.astro";
import SnippetCard from "../components/SnippetCard.astro";
import { loadSnippets } from "../lib/csv";

const snippets = loadSnippets();
const categories = Array.from(new Set(snippets.map((snippet) => snippet.category)));
const types = Array.from(new Set(snippets.map((snippet) => snippet.type)));
const withBase = (path: string) => `${import.meta.env.BASE_URL}${path.replace(/^\//, "")}`;
const modalSnippets = snippets.map((snippet) => ({
  slug: snippet.slug,
  title: snippet.title,
  description: snippet.description,
  category: snippet.category,
  type: snippet.type,
  tags: snippet.tags,
  code: snippet.code,
  created_at: snippet.created_at,
  updated_at: snippet.updated_at,
}));
---
<BaseLayout title="Astro Snippet Library" description="CSV ã‹ã‚‰èª­ã¿è¾¼ã‚€ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¹ãƒ‹ãƒšãƒƒãƒˆé›†">
  <section class="grid gap-6 rounded-3xl border border-white/10 bg-white/5 p-6 pb-20 shadow-xl shadow-indigo-500/10 sm:pb-6">
    <div class="flex flex-wrap items-center gap-4">
      <div>
        <p class="text-xs font-semibold uppercase tracking-[0.2em] text-indigo-200">Search</p>
        <h2 class="text-2xl font-bold">ã‚¹ãƒ‹ãƒšãƒƒãƒˆæ¤œç´¢</h2>
      </div>
      <div class="ml-auto flex flex-wrap items-center gap-3 text-sm text-slate-200/80">
        <span class="rounded-full bg-white/10 px-3 py-1 ring-1 ring-white/10">{snippets.length} ä»¶</span>
        <span id="result-count" class="rounded-full bg-indigo-500/20 px-3 py-1 ring-1 ring-indigo-400/40">{snippets.length} ä»¶ãƒ’ãƒƒãƒˆ</span>
        <div class="hidden items-center gap-2 rounded-full border border-white/10 bg-slate-950/60 p-1 sm:inline-flex">
          <button
            type="button"
            data-view-toggle
            data-view="card"
            aria-pressed="true"
            class="rounded-full px-3 py-1 text-xs font-semibold text-white transition"
          >
            ã‚«ãƒ¼ãƒ‰è¡¨ç¤º
          </button>
          <button
            type="button"
            data-view-toggle
            data-view="table"
            aria-pressed="false"
            class="rounded-full px-3 py-1 text-xs font-semibold text-slate-200/80 transition"
          >
            ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤º
          </button>
        </div>
      </div>
    </div>
    <div class="grid gap-3 sm:grid-cols-[2fr_1fr_1fr]">
      <label class="flex items-center gap-2 rounded-xl border border-white/10 bg-slate-950/60 px-3 py-2 text-sm text-slate-100 shadow-inner">
        <span class="text-indigo-200">ğŸ”</span>
        <input
          id="search"
          type="search"
          placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ (ã‚¿ã‚¤ãƒˆãƒ«ãƒ»èª¬æ˜ãƒ»ã‚¿ã‚°ãƒ»ã‚³ãƒ¼ãƒ‰)"
          class="w-full bg-transparent text-sm outline-none placeholder:text-slate-400"
        />
      </label>
      <label class="flex items-center gap-2 rounded-xl border border-white/10 bg-slate-950/60 px-3 py-2 text-sm text-slate-100 shadow-inner">
        <span class="text-indigo-200">ğŸ“</span>
        <select id="category" class="w-full bg-transparent text-sm outline-none">
          <option value="">ã™ã¹ã¦ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼</option>
          {categories.map((category) => (
            <option value={category}>{category}</option>
          ))}
        </select>
      </label>
      <label class="flex items-center gap-2 rounded-xl border border-white/10 bg-slate-950/60 px-3 py-2 text-sm text-slate-100 shadow-inner">
        <span class="text-indigo-200">ğŸ·ï¸</span>
        <select id="type" class="w-full bg-transparent text-sm outline-none">
          <option value="">ã™ã¹ã¦ã®ã‚¿ã‚¤ãƒ—</option>
          {types.map((type) => (
            <option value={type}>{type}</option>
          ))}
        </select>
      </label>
    </div>

    <div id="snippet-list" class="grid gap-4 sm:grid-cols-2">
      {snippets.map((snippet) => (
        <SnippetCard snippet={snippet} />
      ))}
    </div>

    <div id="snippet-table" class="hidden">
      <div class="overflow-x-auto rounded-2xl border border-white/10 bg-slate-950/40">
        <table class="min-w-full text-left text-sm text-slate-200/85">
          <thead class="bg-white/5 text-xs uppercase tracking-[0.2em] text-indigo-200">
            <tr>
              <th scope="col" class="px-4 py-3">Title</th>
              <th scope="col" class="px-4 py-3">Category</th>
              <th scope="col" class="px-4 py-3">Type</th>
              <th scope="col" class="px-4 py-3">Updated</th>
              <th scope="col" class="px-4 py-3"></th>
            </tr>
          </thead>
          <tbody class="divide-y divide-white/5">
            {snippets.map((snippet) => (
              <tr
                class="transition hover:bg-white/5"
                data-snippet
                data-title={snippet.title.toLowerCase()}
                data-description={snippet.description.toLowerCase()}
                data-tags={snippet.tags.join(" ").toLowerCase()}
                data-code={snippet.code.toLowerCase()}
                data-category={snippet.category}
                data-type={snippet.type}
                data-display="table-row"
              >
                <td class="px-4 py-3 font-semibold text-white">{snippet.title}</td>
                <td class="px-4 py-3 text-indigo-100/90">{snippet.category}</td>
                <td class="px-4 py-3">{snippet.type}</td>
                <td class="px-4 py-3 text-slate-300/80">{snippet.updated_at}</td>
                <td class="px-4 py-3 text-right">
                  <a
                    class="inline-flex items-center gap-1 rounded-full border border-white/15 bg-white/10 px-3 py-1.5 text-xs font-semibold text-white transition hover:border-indigo-200/50 hover:bg-white/20"
                    href={withBase(`/snippets/${snippet.slug}/`)}
                    data-snippet-open
                    data-snippet-slug={snippet.slug}
                  >
                    è©³ç´°ã‚’è¦‹ã‚‹
                    <span aria-hidden="true">â†’</span>
                  </a>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <div class="fixed inset-x-0 bottom-4 z-20 mx-auto flex w-[calc(100%-2rem)] max-w-sm items-center justify-center gap-2 rounded-full border border-white/10 bg-slate-950/80 p-2 text-xs font-semibold text-white shadow-lg shadow-indigo-500/30 backdrop-blur sm:hidden">
    <button
      type="button"
      data-view-toggle
      data-view="card"
      aria-pressed="true"
      class="flex-1 rounded-full px-3 py-2 text-center transition"
    >
      ã‚«ãƒ¼ãƒ‰
    </button>
    <button
      type="button"
      data-view-toggle
      data-view="table"
      aria-pressed="false"
      class="flex-1 rounded-full px-3 py-2 text-center text-slate-200/80 transition"
    >
      ãƒ†ãƒ¼ãƒ–ãƒ«
    </button>
  </div>

  <script type="application/json" id="snippet-data" set:html={JSON.stringify(modalSnippets)}></script>

  <dialog
    id="snippet-modal"
    class="w-full max-w-4xl rounded-3xl border border-white/10 bg-slate-950/95 p-0 text-slate-100 shadow-2xl shadow-indigo-500/30 backdrop:bg-slate-950/70 backdrop:backdrop-blur"
  >
    <div class="flex flex-col gap-6 p-6 sm:p-8">
      <div class="flex items-start justify-between gap-4 border-b border-white/10 pb-4">
        <div>
          <p id="snippet-modal-category" class="text-xs uppercase tracking-[0.2em] text-indigo-200"></p>
          <h2 id="snippet-modal-title" class="mt-2 text-2xl font-bold text-white sm:text-3xl"></h2>
          <p id="snippet-modal-description" class="mt-2 text-sm text-slate-200/80 sm:text-base"></p>
        </div>
        <button
          type="button"
          data-modal-close
          class="rounded-full border border-white/15 bg-white/10 px-3 py-2 text-xs font-semibold text-white transition hover:border-indigo-200/50 hover:bg-white/20"
        >
          é–‰ã˜ã‚‹
        </button>
      </div>

      <div class="flex flex-wrap gap-2 text-xs text-slate-200/80">
        <span class="rounded-full bg-white/10 px-3 py-1 ring-1 ring-white/10">ã‚¿ã‚¤ãƒ—: <span id="snippet-modal-type"></span></span>
        <span class="rounded-full bg-white/10 px-3 py-1 ring-1 ring-white/10">ä½œæˆæ—¥ <span id="snippet-modal-created"></span></span>
        <span class="rounded-full bg-white/10 px-3 py-1 ring-1 ring-white/10">æ›´æ–°æ—¥ <span id="snippet-modal-updated"></span></span>
      </div>

      <div class="grid gap-4 rounded-2xl border border-white/10 bg-slate-950/60 p-5">
        <div class="flex items-center justify-between gap-3">
          <p class="text-sm font-semibold text-white">code</p>
          <button
            class="copy-btn inline-flex items-center gap-2 rounded-full bg-indigo-500 px-4 py-2 text-sm font-semibold text-white shadow-lg shadow-indigo-500/40 transition hover:-translate-y-0.5 hover:shadow-indigo-500/60"
            type="button"
            id="snippet-modal-copy"
            data-copy-code=""
          >
            <span aria-hidden="true">ğŸ“‹</span>
            <span class="copy-label">ã‚³ãƒ”ãƒ¼</span>
          </button>
        </div>
        <pre
          id="snippet-modal-code"
          class="whitespace-pre-wrap rounded-xl border border-white/10 bg-slate-900/80 p-4 text-sm font-mono text-indigo-100"
        ></pre>
        <div id="snippet-modal-tags" class="flex flex-wrap gap-2"></div>
      </div>

      <div class="flex flex-wrap items-center justify-between gap-3 text-sm">
        <p class="text-slate-200/70">è©³ç´°ãƒšãƒ¼ã‚¸ã«ã‚‚ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚</p>
        <a
          id="snippet-modal-link"
          class="rounded-full border border-white/15 bg-white/10 px-4 py-2 text-xs font-semibold text-white transition hover:border-indigo-200/50 hover:bg-white/20"
          href={withBase("/")}
        >
          è©³ç´°ãƒšãƒ¼ã‚¸ã¸
        </a>
      </div>
    </div>
  </dialog>

  <script type="module" define:vars={{ baseUrl: import.meta.env.BASE_URL }}>
    const initPage = () => {
      if (document.body.dataset.snippetPageBound === "true") return;
      document.body.dataset.snippetPageBound = "true";
      const searchInput = document.querySelector("#search");
      const categorySelect = document.querySelector("#category");
      const typeSelect = document.querySelector("#type");
      const cards = Array.from(document.querySelectorAll("[data-snippet]"));
      const resultCount = document.querySelector("#result-count");
      const viewButtons = Array.from(document.querySelectorAll("[data-view-toggle]"));
      const cardList = document.querySelector("#snippet-list");
      const tableList = document.querySelector("#snippet-table");

      const applyFilters = () => {
        const keyword = searchInput?.value.trim().toLowerCase() ?? "";
        const category = categorySelect?.value ?? "";
        const type = typeSelect?.value ?? "";

        let visible = 0;
        cards.forEach((card) => {
          const matchesKeyword = keyword
            ? ["title", "description", "tags", "code"].some((field) =>
                card.dataset[field]?.includes(keyword),
              )
            : true;
          const matchesCategory = category ? card.dataset.category === category : true;
          const matchesType = type ? card.dataset.type === type : true;
          const show = matchesKeyword && matchesCategory && matchesType;
          const display = card.dataset.display ?? "block";
          card.style.display = show ? display : "none";
          if (show) visible += 1;
        });

        if (resultCount) {
          resultCount.textContent = `${visible} ä»¶ãƒ’ãƒƒãƒˆ`;
        }
      };

      const setView = (view) => {
        cardList?.classList.toggle("hidden", view !== "card");
        tableList?.classList.toggle("hidden", view !== "table");
        viewButtons.forEach((button) => {
          const isActive = button.dataset.view === view;
          button.setAttribute("aria-pressed", isActive.toString());
          button.classList.toggle("bg-indigo-500/30", isActive);
          button.classList.toggle("text-white", isActive);
          button.classList.toggle("text-slate-200/80", !isActive);
        });
      };

      [searchInput, categorySelect, typeSelect].forEach((el) => el?.addEventListener("input", applyFilters));
      viewButtons.forEach((button) => {
        button.addEventListener("click", () => {
          const view = button.dataset.view === "table" ? "table" : "card";
          setView(view);
        });
      });

      const snippetModal = document.querySelector("#snippet-modal");
      const snippetDataElement = document.querySelector("#snippet-data");
      const modalTitle = document.querySelector("#snippet-modal-title");
      const modalDescription = document.querySelector("#snippet-modal-description");
      const modalCategory = document.querySelector("#snippet-modal-category");
      const modalType = document.querySelector("#snippet-modal-type");
      const modalCreated = document.querySelector("#snippet-modal-created");
      const modalUpdated = document.querySelector("#snippet-modal-updated");
      const modalCode = document.querySelector("#snippet-modal-code");
      const modalTags = document.querySelector("#snippet-modal-tags");
      const modalCopy = document.querySelector("#snippet-modal-copy");
      const modalLink = document.querySelector("#snippet-modal-link");
      const modalClose = document.querySelector("[data-modal-close]");

      const snippets = snippetDataElement?.textContent ? JSON.parse(snippetDataElement.textContent) : [];
      const snippetMap = new Map(snippets.map((snippet) => [snippet.slug, snippet]));

      const openModal = (slug) => {
        const snippet = snippetMap.get(slug);
        if (!snippet || !snippetModal) return;

        if (modalTitle) modalTitle.textContent = snippet.title;
        if (modalDescription) modalDescription.textContent = snippet.description;
        if (modalCategory) modalCategory.textContent = snippet.category;
        if (modalType) modalType.textContent = snippet.type;
        if (modalCreated) modalCreated.textContent = snippet.created_at;
        if (modalUpdated) modalUpdated.textContent = snippet.updated_at;
        if (modalCode) modalCode.textContent = snippet.code;
        if (modalCopy) modalCopy.dataset.copyCode = snippet.code;
        if (modalLink) modalLink.href = `${baseUrl}snippets/${snippet.slug}/`;

        if (modalTags) {
          modalTags.innerHTML = "";
          snippet.tags.forEach((tag) => {
            const tagEl = document.createElement("span");
            tagEl.className =
              "rounded-full bg-white/10 px-3 py-1 text-xs font-semibold text-indigo-50 ring-1 ring-white/10";
            tagEl.textContent = tag;
            modalTags.appendChild(tagEl);
          });
        }

        document.body.classList.add("overflow-hidden");
        snippetModal.showModal();
      };

      const closeModal = () => {
        if (!snippetModal) return;
        snippetModal.close();
      };

      const openButtons = Array.from(document.querySelectorAll("[data-snippet-open]"));
      openButtons.forEach((button) => {
        if (button.dataset.modalBound === "true") return;
        button.dataset.modalBound = "true";
        button.addEventListener("click", (event) => {
          event.preventDefault();
          const slug = button.dataset.snippetSlug;
          if (slug) openModal(slug);
        });
      });

      modalClose?.addEventListener("click", closeModal);
      snippetModal?.addEventListener("click", (event) => {
        if (event.target === snippetModal) closeModal();
      });
      snippetModal?.addEventListener("close", () => {
        document.body.classList.remove("overflow-hidden");
      });

      applyFilters();
      setView("card");
    };

    document.addEventListener("DOMContentLoaded", initPage);
    document.addEventListener("astro:page-load", initPage);
  </script>
</BaseLayout>
